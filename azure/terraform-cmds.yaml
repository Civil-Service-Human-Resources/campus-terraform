parameters:
  - name: env

steps:

  - task: CmdLine@2
    displayName: Terraform Init - ${{parameters.env}}
    inputs:
      script: terraform init -backend-config="access_key=$(tf-state-access-key)" -backend-config="storage_account_name=$(tf-state-sa-name)" -backend-config="resource_group_name=$(tf-state-rg-name)" -backend-config="container_name=$(tf-state-container-name)" -backend-config="key=${{parameters.env}}.$(tf-state-key-suffix)"
      workingDirectory: environments/${{parameters.env}}

  - task: CmdLine@2
    displayName: Terraform Validate - ${{parameters.env}}
    inputs:
      script: terraform validate
      workingDirectory: environments/${{parameters.env}}

  - task: TerraformTaskV2@2
    inputs:
      provider: 'azurerm'
      command: 'plan'
      workingDirectory: '$(System.DefaultWorkingDirectory)/environments/${{parameters.env}}'
      commandOptions: '-input=false -out=${{parameters.env}}-tfplan'
      environmentServiceNameAzureRM: 'AzDevOps CSL Staging'

  - task: ArchiveFiles@2
    displayName: Archive Terraform Plan Files - ${{parameters.env}}
    inputs:
      rootFolderOrFile: environments/${{parameters.env}}
      archiveType: tar
      sevenZipCompression: fastest
      archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-${{parameters.env}}-tfplan.tgz
